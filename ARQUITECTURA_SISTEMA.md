# ๐ DIAGRAMA Y ARQUITECTURA DEL SISTEMA

## ๐๏ธ Diagrama de Base de Datos

```
โโโโโโโโโโโโโโโโโโโโโโโ
โ   auth.users        โ
โ  (Supabase Auth)    โ
โโโโโโโโโโโโฌโโโโโโโโโโโ
           โ
           โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
           โ                                          โ
           โผ                                          โผ
โโโโโโโโโโโโโโโโโโโโโโโ                    โโโโโโโโโโโโโโโโโโโโโโโ
โ  perfiles_usuario   โ                    โ    repartidores     โ
โโโโโโโโโโโโโโโโโโโโโโโค                    โโโโโโโโโโโโโโโโโโโโโโโค
โ โข usuario_id (FK)   โ                    โ โข usuario_id (FK)   โ
โ โข rol               โ                    โ โข nombre_completo   โ
โ โข nombre_completo   โ                    โ โข tipo_vehiculo     โ
โ โข telefono          โ                    โ โข disponible        โ
โ โข direccion_default โ                    โ โข lat/lng_actual    โ
โโโโโโโโโโโโโโโโโโโโโโโ                    โ โข total_entregas    โ
                                           โ โข calificacion      โ
                                           โโโโโโโโโโโโฌโโโโโโโโโโโ
                                                      โ
           โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
           โ                                          โ
           โผ                                          โผ
โโโโโโโโโโโโโโโโโโโโโโโ              โโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ    restaurantes     โ              โ ubicaciones_repartidor   โ
โโโโโโโโโโโโโโโโโโโโโโโค              โโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ โข nombre            โ              โ โข repartidor_id (FK)     โ
โ โข direccion         โ              โ โข pedido_id (FK)         โ
โ โข emoji             โ              โ โข latitud/longitud       โ
โ โข telefono          โ              โ โข velocidad              โ
โโโโโโโโโโโโฌโโโโโโโโโโโ              โ โข precision_metros       โ
           โ                         โ โข creado_en              โ
           โ                         โโโโโโโโโโโโโโโโโโโโโโโโโโโโ
           โ
           โโโโโโโโโโโโโโโโ
           โ              โ
           โผ              โผ
โโโโโโโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโโโโโ
โ    categorias       โ  โ      platillos      โ
โโโโโโโโโโโโโโโโโโโโโโโค  โโโโโโโโโโโโโโโโโโโโโโโค
โ โข nombre            โ  โ โข restaurante_id(FK)โ
โโโโโโโโโโโโฌโโโโโโโโโโโ  โ โข categoria_id (FK) โ
           โ             โ โข nombre            โ
           โโโโโโโโโโโโโโโค โข categoria_tipo    โโโโโโโ
                         โ โข precio            โ     โ
                         โ โข imagen_url        โ     โ
                         โโโโโโโโโโโโฌโโโโโโโโโโโ     โ
                                    โ                โ
                                    โ                โ
           โโโโโโโโโโโโโโโโโโโโโโโโโโดโโโโโโโโโโโโโโโโโค
           โ                                         โ
           โผ                                         โ
โโโโโโโโโโโโโโโโโโโโโโโ                             โ
โ      carrito        โ                             โ
โโโโโโโโโโโโโโโโโโโโโโโค                             โ
โ โข usuario_id (FK)   โ                             โ
โ โข platillo_id (FK)  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ โข restaurante_id(FK)โ
โ โข cantidad          โ
โ โข precio_unitario   โ
โ โข notas             โ
โโโโโโโโโโโโโโโโโโโโโโโ
           โ
           โ crear_pedido_desde_carrito()
           โ
           โผ
โโโโโโโโโโโโโโโโโโโโโโโ
โ      pedidos        โ
โโโโโโโโโโโโโโโโโโโโโโโค
โ โข usuario_id (FK)   โ
โ โข restaurante_id(FK)โ
โ โข repartidor_id(FK) โ
โ โข numero_pedido     โ
โ โข total             โ
โ โข estado            โโโโโ Estados:
โ โข direccion_entrega โ    โข pendiente
โ โข latitud/longitud  โ    โข confirmado
โ โข notas_cliente     โ    โข en_preparacion
โ โข confirmado_en     โ    โข listo
โ โข asignado_en       โ    โข en_camino
โ โข entregado_en      โ    โข entregado
โโโโโโโโโโโโฌโโโโโโโโโโโ    โข cancelado
           โ
           โ
           โผ
โโโโโโโโโโโโโโโโโโโโโโโ
โ  detalle_pedidos    โ
โโโโโโโโโโโโโโโโโโโโโโโค
โ โข pedido_id (FK)    โ
โ โข platillo_id (FK)  โ
โ โข cantidad          โ
โ โข precio_unitario   โ
โ โข subtotal          โ
โ โข notas             โ
โโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโ
โ   notificaciones    โ
โโโโโโโโโโโโโโโโโโโโโโโค
โ โข usuario_id (FK)   โ
โ โข tipo              โ
โ โข titulo            โ
โ โข mensaje           โ
โ โข pedido_id (FK)    โ
โ โข leida             โ
โโโโโโโโโโโโโโโโโโโโโโโ
```

## ๐ Flujo de Estados del Pedido

```
Cliente                    Sistema                   Repartidor
  โ                           โ                          โ
  โโ Agregar al carrito       โ                          โ
  โโ Crear pedido โโโโโโโโโโโโโบ                          โ
  โ                           โ                          โ
  โ                      [PENDIENTE]                     โ
  โ                           โ                          โ
  โ                      โ Confirmar                    โ
  โ                           โ                          โ
  โ                      [CONFIRMADO]                    โ
  โ                           โ                          โ
  โ                      ๐จโ๐ณ Preparar                    โ
  โ                           โ                          โ
  โ                    [EN_PREPARACION]                  โ
  โ                           โ                          โ
  โ                      โ Listo                        โ
  โ                           โ                          โ
  โ                        [LISTO]                       โ
  โ                           โ                          โ
  โ                           โโโโโโโโ Ver disponibles โโโค
  โ                           โ                          โ
  โ                           โโโโโโโโ Tomar pedido โโโโโโค
  โ                           โ                          โ
  โโโโโโ Notificaciรณn โโโโ[ASIGNAR_REPARTIDOR]          โ
  โ                           โ                          โ
  โ                      [EN_CAMINO] โโโโโโโโโโโโโโโโโโโโโบ
  โ                           โ                          โ
  โ                   ๐บ๏ธ Tracking GPS activo             โ
  โ                   Actualizaciรณn cada 60s             โ
  โ                           โ                          โ
  โโ Ver mapa                 โโโโโโโโ GPS update โโโโโโโโค
  โโ Ver ubicaciรณn            โ                          โ
  โ                           โ                          โ
  โ                           โโโโโโโโ Entregar โโโโโโโโโโค
  โ                           โ                          โ
  โโโโโโ Notificaciรณn โโโโ[ENTREGADO]                    โ
  โ                           โ                          โ
  โโ โ Pedido recibido        โ                          โโ โ Entrega completa
```

## ๐ฏ Arquitectura del Sistema

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    CLIENTE WEB/APP                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                          โ
โ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ  โ
โ  โ   Home       โ  โ   Carrito    โ  โ   Pedidos    โ  โ
โ  โ  Cliente     โ  โ              โ  โ   Activos    โ  โ
โ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ  โ
โ                                                          โ
โ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ  โ
โ  โ  Detalle     โ  โ   Tracking   โ  โ    Mapa      โ  โ
โ  โ   Pedido     โ  โ   GPS        โ  โ  Leaflet     โ  โ
โ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ  โ
โ                                                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                         โ
                         โ React + TypeScript
                         โ Supabase Client
                         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    REPARTIDOR WEB/APP                     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                           โ
โ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ   โ
โ  โ   Pedidos    โ  โ     Mis      โ  โ   Entrega    โ   โ
โ  โ Disponibles  โ  โ   Pedidos    โ  โ    Activa    โ   โ
โ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ   โ
โ                                                           โ
โ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ   โ
โ  โ    Perfil    โ  โ  Estadรญs-    โ  โ  GPS Auto    โ   โ
โ  โ  Repartidor  โ  โ   ticas      โ  โ  Tracking    โ   โ
โ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ   โ
โ                                                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                         โ
                         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    SUPABASE BACKEND                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                            โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โ  โ              PostgreSQL Database                  โ    โ
โ  โ  โข 8 Tablas principales                          โ    โ
โ  โ  โข 9 Vistas optimizadas                          โ    โ
โ  โ  โข 20+ Funciones SQL                             โ    โ
โ  โ  โข RLS (Row Level Security)                      โ    โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โ                                                            โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โ  โ          Realtime Subscriptions                   โ    โ
โ  โ  โข Cambios en pedidos                            โ    โ
โ  โ  โข Actualizaciones GPS                           โ    โ
โ  โ  โข Notificaciones                                โ    โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โ                                                            โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โ  โ              Authentication                       โ    โ
โ  โ  โข Sign up / Sign in                             โ    โ
โ  โ  โข JWT Tokens                                    โ    โ
โ  โ  โข Roles: cliente, repartidor, admin             โ    โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โ                                                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                         โ
                         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ              SERVICIOS EXTERNOS (OPCIONALES)               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                            โ
โ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ      โ
โ  โ OpenStreet  โ  โ  Firebase   โ  โ   Stripe    โ      โ
โ  โ    Map      โ  โ  Messaging  โ  โ   Payments  โ      โ
โ  โ  (Gratis)   โ  โ   (Push)    โ  โ  (Pagos)    โ      โ
โ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ      โ
โ                                                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## ๐ Seguridad RLS

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                  Row Level Security                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                      โ
โ  CLIENTE puede:                                      โ
โ  โ Ver sus propios pedidos                         โ
โ  โ Ver su propio carrito                           โ
โ  โ Ver info repartidor asignado                    โ
โ  โ Ver ubicaciรณn solo en pedido activo             โ
โ  โ Ver sus notificaciones                          โ
โ  โ Ver pedidos de otros clientes                   โ
โ  โ Ver ubicaciรณn de otros repartidores             โ
โ                                                      โ
โ  REPARTIDOR puede:                                   โ
โ  โ Ver pedidos disponibles                         โ
โ  โ Ver sus pedidos asignados                       โ
โ  โ Actualizar su ubicaciรณn                         โ
โ  โ Ver su perfil y estadรญsticas                    โ
โ  โ Tomar y entregar pedidos                        โ
โ  โ Ver pedidos de otros repartidores               โ
โ  โ Modificar datos de otros usuarios               โ
โ                                                      โ
โ  ADMIN puede:                                        โ
โ  โ Ver todo (configurar segรบn necesidad)           โ
โ                                                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## ๐ก Sistema de Tracking GPS

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ            GPS Tracking en Tiempo Real               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                      โ
โ  REPARTIDOR:                                         โ
โ  1. Toma pedido                                      โ
โ  2. Se activa watchPosition()                        โ
โ  3. GPS del dispositivo captura ubicaciรณn            โ
โ  4. Envรญa a Supabase cada 60 segundos               โ
โ  5. Guarda en tabla ubicaciones_repartidor           โ
โ                                                      โ
โ  CLIENTE:                                            โ
โ  1. Ve botรณn "Ver Ubicaciรณn"                        โ
โ  2. Abre mapa con Leaflet                           โ
โ  3. Suscripciรณn Realtime a cambios                  โ
โ  4. Mapa se actualiza automรกticamente               โ
โ  5. Ve marcador azul (repartidor) moviรฉndose        โ
โ                                                      โ
โ  PRECISIรN:                                          โ
โ  โข enableHighAccuracy: true                         โ
โ  โข Actualizaciรณn: 60 segundos                       โ
โ  โข Historial completo guardado                      โ
โ  โข Velocidad calculada                              โ
โ                                                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## ๐ Sistema de Notificaciones

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ          Notificaciones Automรกticas                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                     โ
โ  TRIGGER EN CAMBIO DE ESTADO:                       โ
โ                                                     โ
โ  Estado: CONFIRMADO                                 โ
โ  โโโบ Notificar Cliente                             โ
โ  โโโบ "ยกPedido Confirmado!"                         โ
โ                                                     โ
โ  Estado: EN_PREPARACION                             โ
โ  โโโบ Notificar Cliente                             โ
โ  โโโบ "ยกEn Preparaciรณn!"                            โ
โ                                                     โ
โ  Estado: LISTO                                      โ
โ  โโโบ Notificar Cliente                             โ
โ  โโโบ "ยกPedido Listo!"                              โ
โ                                                     โ
โ  ASIGNAR REPARTIDOR:                                โ
โ  โโโบ Notificar Cliente                             โ
โ  โ   "ยกRepartidor asignado!"                       โ
โ  โโโบ Notificar Repartidor                          โ
โ      "ยกNuevo Pedido!"                               โ
โ                                                     โ
โ  Estado: EN_CAMINO                                  โ
โ  โโโบ Notificar Cliente                             โ
โ  โโโบ "ยกEn Camino! Ver ubicaciรณn"                   โ
โ                                                     โ
โ  Estado: ENTREGADO                                  โ
โ  โโโบ Notificar Cliente                             โ
โ  โโโบ "ยกPedido Entregado!"                          โ
โ                                                     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

Este diagrama muestra toda la arquitectura del sistema de delivery completo. ๐
